services:
  postgres:
    image: postgres:15-alpine
    container_name: lykos-postgres
    environment:
      POSTGRES_DB: lykos_dev
      POSTGRES_USER: lykos
      POSTGRES_PASSWORD: devpassword
    ports:
      - "5433:5432"  # Host:Container - use localhost:5433 from host
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U lykos -d lykos_dev"]
      interval: 10s
      timeout: 5s
      retries: 5
    # Resource limits to prevent overload
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    # Optimize PostgreSQL for development
    command: postgres -c shared_buffers=128MB -c max_connections=50

  redis:
    image: redis:7-alpine
    container_name: lykos-redis
    ports:
      - "6379:6379"
    # Disable AOF in dev to reduce I/O (optional)
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M

  # Vault is optional for development - comment out if you don't need it
  # Uncomment and ensure vault image is available if you need it
  # vault:
  #   image: hashicorp/vault:latest
  #   container_name: lykos-vault
  #   environment:
  #     VAULT_DEV_ROOT_TOKEN_ID: dev-token
  #     VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
  #   ports:
  #     - "8200:8200"
  #   cap_add:
  #     - IPC_LOCK
  #   volumes:
  #     - vault_data:/vault/data

volumes:
  postgres_data:
  redis_data:
  # vault_data:
